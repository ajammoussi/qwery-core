{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": "-- Grafana --",
        "enable": true,
        "hide": false,
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "description": "LLM Observability Dashboard: spans, tokens, latency, errors, billing",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": 1,
  "links": [],
  "panels": [
    {
      "datasource": "ClickHouse",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            },
            "footer": {
              "reducers": []
            },
            "inspect": false
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 1,
      "options": {
        "cellHeight": "sm",
        "showHeader": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "adHocFilters": [],
          "adHocValuesQuery": "",
          "add_metadata": true,
          "contextWindowSize": "10",
          "editorMode": "builder",
          "extrapolate": true,
          "format": "table",
          "formattedQuery": "/* grafana dashboard='LLM Observability Dashboard', user=1 */\nSELECT\n    Timestamp AS ts,\n    concat(\n        '[', SpanName, '] ',\n        'svc=', ServiceName, ' ',\n        'conv=', SpanAttributes['agent.conversation.id'], ' ',\n        'actor=', SpanAttributes['agent.actor'], ' ',\n        'tokens=', SpanAttributes['agent.llm.total.tokens'], ' ',\n        'user=', SpanAttributes['user.id']\n    ) AS line\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64(1766023933259/1000, 9)\n                    AND toDateTime64(1766067133259/1000, 9)\n\nORDER BY Timestamp DESC\nLIMIT 1000",
          "interval": "",
          "intervalFactor": 1,
          "nullifySparse": false,
          "query": "SELECT\n    Timestamp AS ts,\n    concat(\n        '[', SpanName, '] ',\n        'svc=', ServiceName, ' ',\n        'conv=', SpanAttributes['agent.conversation.id'], ' ',\n        'actor=', SpanAttributes['agent.actor'], ' ',\n        'tokens=', SpanAttributes['agent.llm.total.tokens'], ' ',\n        'user=', SpanAttributes['user.id']\n    ) AS line\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9)\n                    AND toDateTime64($__to/1000, 9)\n\nORDER BY Timestamp DESC\nLIMIT 1000\n",
          "rawSql": "SELECT\n    Timestamp AS ts,\n    concat('[', SpanName, '] ', 'conv=', SpanAttributes['agent.conversation.id'], ' ', 'actor=', SpanAttributes['agent.actor'], ' ', 'tokens=', SpanAttributes['agent.llm.total.tokens'], ' ', 'user=', SpanAttributes['user.id']) AS line\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9) AND toDateTime64($__to/1000, 9)\n  AND SpanAttributes['application.type'] IN ($app_type)\n  AND SpanAttributes['user.id'] IN ($user_id)\nORDER BY Timestamp DESC\nLIMIT 1000;",
          "refId": "A",
          "round": "0s",
          "skip_comments": true,
          "useWindowFuncForMacros": true
        }
      ],
      "title": "Raw Spans (All)",
      "type": "table"
    },
    {
      "datasource": "ClickHouse",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 8
      },
      "id": 2,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "adHocFilters": [],
          "adHocValuesQuery": "",
          "add_metadata": true,
          "contextWindowSize": "10",
          "editorMode": "builder",
          "extrapolate": true,
          "format": "time_series",
          "formattedQuery": "/* grafana dashboard='LLM Observability Dashboard', user=1 */\nSELECT\n    toStartOfHour(Timestamp) AS t,\n    SpanAttributes['agent.actor.type'] AS actor_type,\n    avg(toFloat64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS avg_tokens\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64(1765782896910/1000, 9) \n                    AND toDateTime64(1765826096910/1000, 9)\n  AND SpanAttributes['application.type'] IN ('qwery-cli')\n  AND SpanAttributes['user.id'] IN ('cli-1765813001600-bpxq1zs')\n  AND SpanAttributes['agent.actor'] IN ('detectIntent','greeting')\nGROUP BY t, actor_type\nORDER BY t ASC",
          "interval": "",
          "intervalFactor": 1,
          "nullifySparse": false,
          "query": "SELECT\n    toStartOfHour(Timestamp) AS t,\n    SpanAttributes['agent.actor.type'] AS actor_type,\n    avg(toFloat64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS avg_tokens\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9) \n                    AND toDateTime64($__to/1000, 9)\n  AND SpanAttributes['application.type'] IN ($app_type)\n  AND SpanAttributes['user.id'] IN ($user_id)\n  AND SpanAttributes['agent.actor'] IN ($agent)\nGROUP BY t, actor_type\nORDER BY t ASC",
          "rawSql": "SELECT\n    toStartOfHour(Timestamp) AS t,\n    SpanAttributes['agent.actor.type'] AS model,\n    avg(toFloat64(toUInt64OrZero(SpanAttributes['agent.llm.total.tokens']))) AS tokens\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9) AND toDateTime64($__to/1000, 9)\n  AND has(mapKeys(SpanAttributes), 'agent.llm.total.tokens')\n  AND SpanAttributes['application.type'] IN ($app_type)\n  AND SpanAttributes['user.id'] IN ($user_id)\n  AND SpanAttributes['agent.actor'] IN ($agent)\nGROUP BY t, model\nORDER BY t ASC",
          "refId": "A",
          "round": "0s",
          "skip_comments": true,
          "useWindowFuncForMacros": true
        }
      ],
      "title": "Avg. Tokens by Agent (Hourly)",
      "type": "timeseries"
    },
    {
      "datasource": "ClickHouse",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 8
      },
      "id": 3,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "adHocFilters": [],
          "adHocValuesQuery": "",
          "add_metadata": true,
          "contextWindowSize": "10",
          "editorMode": "builder",
          "extrapolate": true,
          "format": "time_series",
          "formattedQuery": "/* grafana dashboard='LLM Observability Dashboard', user=1 */\nSELECT\n    toStartOfHour(Timestamp) AS t,\n    SpanAttributes['agent.llm.model'] AS model,\n    sum(toUInt64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS total_tokens\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64(1765826841325/1000, 9) AND toDateTime64(1765828641325/1000, 9)\nGROUP BY t, model\nORDER BY t ASC\nLIMIT 10",
          "interval": "",
          "intervalFactor": 1,
          "nullifySparse": false,
          "query": "SELECT\n    toStartOfHour(Timestamp) AS t,\n    SpanAttributes['agent.llm.model'] AS model,\n    sum(toUInt64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS total_tokens\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9) AND toDateTime64($__to/1000, 9)\nGROUP BY t, model\nORDER BY t ASC\nLIMIT 10",
          "rawSql": "SELECT\n    toStartOfHour(Timestamp) AS t,\n    SpanAttributes['agent.llm.model'] AS model,\n    sum(toUInt64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS tokens\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9) AND toDateTime64($__to/1000, 9)\n  AND has(mapKeys(SpanAttributes), 'agent.llm.total.tokens')\n  AND SpanAttributes['application.type'] IN ($app_type)\n  AND SpanAttributes['user.id'] IN ($user_id)\n  AND SpanAttributes['agent.llm.model'] IN ($model)\nGROUP BY t, model\nORDER BY t;",
          "refId": "B",
          "round": "0s",
          "skip_comments": true,
          "useWindowFuncForMacros": true
        }
      ],
      "title": "Total Tokens by Model (Hourly)",
      "type": "timeseries"
    },
    {
      "datasource": "ClickHouse",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 16
      },
      "id": 4,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "adHocFilters": [],
          "adHocValuesQuery": "",
          "add_metadata": true,
          "contextWindowSize": "10",
          "editorMode": "builder",
          "extrapolate": true,
          "format": "time_series",
          "formattedQuery": "/* grafana dashboard='LLM Observability Dashboard', user=1 */\nSELECT\n    toStartOfHour(Timestamp) AS t,\n    SpanAttributes['application.type'] AS app_type,\n    sum(toUInt64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS total_tokens\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64(1766023031590/1000, 9)\n                    AND toDateTime64(1766066231590/1000, 9)\n  AND has(mapKeys(SpanAttributes), 'agent.llm.total.tokens')\n  AND SpanAttributes['application.type'] IN ('qwery-web-server')\n  AND SpanAttributes['user.id'] IN ('cli-1766051924571-27q4q45','web-1766065295881-yugqvzi','web-1766065544866-y1ki9q2')\nGROUP BY t, app_type\nORDER BY t ASC",
          "interval": "",
          "intervalFactor": 1,
          "nullifySparse": false,
          "query": "SELECT\n    toStartOfHour(Timestamp) AS t,\n    SpanAttributes['application.type'] AS app_type,\n    sum(toUInt64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS total_tokens\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9)\n                    AND toDateTime64($__to/1000, 9)\n  AND has(mapKeys(SpanAttributes), 'agent.llm.total.tokens')\n  AND SpanAttributes['application.type'] IN ($app_type)\n  AND SpanAttributes['user.id'] IN ($user_id)\nGROUP BY t, app_type\nORDER BY t ASC\n",
          "rawSql": "SELECT\n    toStartOfHour(Timestamp) AS t,\n    SpanAttributes['application.type'] AS app_type,\n    sum(toUInt64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS tokens\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9) AND toDateTime64($__to/1000, 9)\n  AND has(mapKeys(SpanAttributes), 'agent.llm.total.tokens')\n  AND SpanAttributes['application.type'] IN ($app_type)\n  AND SpanAttributes['user.id'] IN ($user_id)\nGROUP BY t, app_type\nORDER BY t;",
          "refId": "C",
          "round": "0s",
          "skip_comments": true,
          "useWindowFuncForMacros": true
        }
      ],
      "title": "Total Tokens by Application Type (Hourly)",
      "type": "timeseries"
    },
    {
      "datasource": "ClickHouse",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "ms"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 16
      },
      "id": 5,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "adHocFilters": [],
          "adHocValuesQuery": "",
          "add_metadata": true,
          "contextWindowSize": "10",
          "editorMode": "builder",
          "extrapolate": true,
          "format": "time_series",
          "formattedQuery": "/* grafana dashboard='LLM Observability Dashboard', user=1 */\nSELECT\n    toStartOfHour(Timestamp) AS t,\n    SpanAttributes['agent.actor'] AS actor,\n    avg(Duration / 1e6) AS avg_ms\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64(1765804703089/1000, 9)\n                    AND toDateTime64(1765826303089/1000, 9)\n  AND SpanName LIKE 'agent.actor.%'\n  AND SpanAttributes['application.type'] IN ('qwery-cli')\n  AND SpanAttributes['user.id'] IN ('cli-1765813001600-bpxq1zs')\n  AND SpanAttributes['agent.actor'] IN ('detectIntent','greeting')\nGROUP BY t, actor\nORDER BY t ASC",
          "interval": "",
          "intervalFactor": 1,
          "nullifySparse": false,
          "query": "SELECT\n    toStartOfHour(Timestamp) AS t,\n    SpanAttributes['agent.actor'] AS actor,\n    avg(Duration / 1e6) AS avg_ms\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9)\n                    AND toDateTime64($__to/1000, 9)\n  AND SpanName LIKE 'agent.actor.%'\n  AND SpanAttributes['application.type'] IN ($app_type)\n  AND SpanAttributes['user.id'] IN ($user_id)\n  AND SpanAttributes['agent.actor'] IN ($agent)\nGROUP BY t, actor\nORDER BY t ASC\n",
          "rawSql": "SELECT\n    toStartOfHour(Timestamp) AS t,\n    SpanAttributes['agent.actor'] AS actor,\n    avg(Duration / 1e6) AS avg_ms\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9) AND toDateTime64($__to/1000, 9)\n  AND SpanName LIKE 'agent.actor.%'\n  AND SpanAttributes['application.type'] IN ($app_type)\n  AND SpanAttributes['user.id'] IN ($user_id)\n  AND SpanAttributes['agent.actor'] IN ($agent)\nGROUP BY t, actor\nORDER BY t;",
          "refId": "D",
          "round": "0s",
          "skip_comments": true,
          "useWindowFuncForMacros": true
        }
      ],
      "title": "Average Actor Duration (ms) (Hourly)",
      "type": "timeseries"
    },
    {
      "datasource": "ClickHouse",
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 6,
        "w": 24,
        "x": 0,
        "y": 24
      },
      "id": 6,
      "options": {
        "dedupStrategy": "none",
        "enableInfiniteScrolling": false,
        "enableLogDetails": true,
        "showControls": false,
        "showTime": false,
        "sortOrder": "Descending",
        "wrapLogMessage": false
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "adHocFilters": [],
          "adHocValuesQuery": "",
          "add_metadata": true,
          "contextWindowSize": "10",
          "editorMode": "builder",
          "extrapolate": true,
          "format": "table",
          "formattedQuery": "/* grafana dashboard='LLM Observability Dashboard', user=1 */\nSELECT\n    Timestamp,\n    SpanName,\n    SpanAttributes['agent.actor'] AS actor,\n    StatusMessage\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64(1765822513022/1000, 9)\n                    AND toDateTime64(1765844113022/1000, 9)\n  AND StatusCode != 'Ok'\n  AND SpanAttributes['application.type'] IN ('qwery-cli')\n  AND SpanAttributes['user.id'] IN ('cli-1765813001600-bpxq1zs')\nORDER BY Timestamp DESC",
          "interval": "",
          "intervalFactor": 1,
          "nullifySparse": false,
          "query": "SELECT\n    Timestamp,\n    SpanName,\n    SpanAttributes['agent.actor'] AS actor,\n    StatusMessage\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9)\n                    AND toDateTime64($__to/1000, 9)\n  AND StatusCode != 'Ok'\n  AND SpanAttributes['application.type'] IN ($app_type)\n  AND SpanAttributes['user.id'] IN ($user_id)\nORDER BY Timestamp DESC\n",
          "rawSql": "SELECT\n  Timestamp,\n  SpanName,\n  SpanAttributes['agent.actor'] AS actor,\n  StatusMessage\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9) AND toDateTime64($__to/1000, 9)\n  AND StatusCode != 'Ok'\n  AND SpanAttributes['application.type'] IN ($app_type)\n  AND SpanAttributes['user.id'] IN ($user_id)\nORDER BY Timestamp DESC",
          "refId": "E",
          "round": "0s",
          "skip_comments": true,
          "useWindowFuncForMacros": true
        }
      ],
      "title": "Errors (Filtered)",
      "type": "logs"
    },
    {
      "datasource": "ClickHouse",
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            },
            "footer": {
              "reducers": []
            },
            "inspect": false
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 6,
        "w": 24,
        "x": 0,
        "y": 30
      },
      "id": 7,
      "options": {
        "cellHeight": "sm",
        "showHeader": true
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "adHocFilters": [],
          "adHocValuesQuery": "",
          "add_metadata": true,
          "contextWindowSize": "10",
          "editorMode": "builder",
          "extrapolate": true,
          "format": "table",
          "formattedQuery": "/* grafana dashboard='LLM Observability Dashboard', user=1 */\nSELECT\n    SpanAttributes['user.id'] AS user_id,\n    SpanAttributes['application.type'] AS app_type,\n    sum(toUInt64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS total_tokens\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64(1765804703089/1000, 9)\n                    AND toDateTime64(1765826303089/1000, 9)\n  AND has(mapKeys(SpanAttributes), 'agent.llm.total.tokens')\n  AND SpanAttributes['application.type'] IN ('qwery-cli')\n  AND SpanAttributes['user.id'] IN ('cli-1765813001600-bpxq1zs')\nGROUP BY user_id, app_type\nORDER BY total_tokens DESC",
          "interval": "",
          "intervalFactor": 1,
          "nullifySparse": false,
          "query": "SELECT\n    SpanAttributes['user.id'] AS user_id,\n    SpanAttributes['application.type'] AS app_type,\n    sum(toUInt64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS total_tokens\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9)\n                    AND toDateTime64($__to/1000, 9)\n  AND has(mapKeys(SpanAttributes), 'agent.llm.total.tokens')\n  AND SpanAttributes['application.type'] IN ($app_type)\n  AND SpanAttributes['user.id'] IN ($user_id)\nGROUP BY user_id, app_type\nORDER BY total_tokens DESC\n",
          "rawSql": "SELECT\n  SpanAttributes['user.id'] AS user_id,\n  SpanAttributes['application.type'] AS app_type,\n  sum(toUInt64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS total_tokens\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9) AND toDateTime64($__to/1000, 9)\n  AND has(mapKeys(SpanAttributes), 'agent.llm.total.tokens')\n  AND SpanAttributes['application.type'] IN ($app_type)\n  AND SpanAttributes['user.id'] IN ($user_id)\nGROUP BY user_id, app_type\nORDER BY total_tokens DESC",
          "refId": "F",
          "round": "0s",
          "skip_comments": true,
          "useWindowFuncForMacros": true
        }
      ],
      "title": "Per-User/App Token Usage (Billing)",
      "type": "table"
    },
    {
      "datasource": "ClickHouse",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": []
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 36
      },
      "id": 8,
      "options": {
        "displayLabels": [
          "value"
        ],
        "legend": {
          "displayMode": "list",
          "placement": "right",
          "showLegend": true
        },
        "pieType": "pie",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": true
        },
        "sort": "desc",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "adHocFilters": [],
          "adHocValuesQuery": "",
          "add_metadata": true,
          "contextWindowSize": "10",
          "editorMode": "builder",
          "extrapolate": true,
          "format": "table",
          "formattedQuery": "/* grafana dashboard='LLM Observability Dashboard', user=1 */\nSELECT\n    SpanAttributes['agent.actor'] AS agent,\n    sum(toUInt64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS tokens\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64(1765969907640/1000, 9)\n                    AND toDateTime64(1766056307640/1000, 9)\n  AND has(SpanAttributes, 'agent.llm.total.tokens')\n  AND SpanAttributes['application.type'] IN ('qwery-web-server')\n  AND SpanAttributes['user.id'] IN ('cli-1766051924571-27q4q45')\n  AND SpanAttributes['agent.actor'] IN ('detectIntent','greeting','loadContext')\nGROUP BY agent\nORDER BY tokens DESC",
          "interval": "",
          "intervalFactor": 1,
          "nullifySparse": false,
          "query": "SELECT\n    SpanAttributes['agent.actor'] AS agent,\n    sum(toUInt64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS tokens\nFROM otel_traces\nWHERE Timestamp BETWEEN toDateTime64($__from/1000, 9)\n                    AND toDateTime64($__to/1000, 9)\n  AND has(SpanAttributes, 'agent.llm.total.tokens')\n  AND SpanAttributes['application.type'] IN ($app_type)\n  AND SpanAttributes['user.id'] IN ($user_id)\n  AND SpanAttributes['agent.actor'] IN ($agent)\nGROUP BY agent\nORDER BY tokens DESC",
          "refId": "A",
          "round": "0s",
          "skip_comments": true,
          "useWindowFuncForMacros": true
        }
      ],
      "title": "Token Usage by Agent",
      "type": "piechart"
    },
    {
      "datasource": "ClickHouse",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 36
      },
      "id": 9,
      "options": {
        "barRadius": 0,
        "barWidth": 0.97,
        "fullHighlight": false,
        "groupWidth": 0.7,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "orientation": "vertical",
        "showValue": "always",
        "stacking": "none",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        },
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "12.3.0",
      "targets": [
        {
          "adHocFilters": [],
          "adHocValuesQuery": "",
          "add_metadata": true,
          "contextWindowSize": "10",
          "editorMode": "builder",
          "extrapolate": true,
          "format": "table",
          "formattedQuery": "/* grafana dashboard='LLM Observability Dashboard', user=1 */\nSELECT SpanAttributes['agent.llm.model'] AS model, sum(toUInt64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS tokens FROM otel_traces WHERE Timestamp BETWEEN toDateTime64(1765801804347/1000, 9) AND toDateTime64(1765845004347/1000, 9) AND has(mapKeys(SpanAttributes), 'agent.llm.total.tokens') AND SpanAttributes['application.type'] IN ('qwery-cli') AND SpanAttributes['user.id'] IN ('cli-1765813001600-bpxq1zs') AND SpanAttributes['agent.llm.model'] IN () GROUP BY model ORDER BY tokens DESC",
          "interval": "",
          "intervalFactor": 1,
          "nullifySparse": false,
          "query": "SELECT SpanAttributes['agent.llm.model'] AS model, sum(toUInt64OrZero(SpanAttributes['agent.llm.total.tokens'])) AS tokens FROM otel_traces WHERE Timestamp BETWEEN toDateTime64($__from/1000, 9) AND toDateTime64($__to/1000, 9) AND has(mapKeys(SpanAttributes), 'agent.llm.total.tokens') AND SpanAttributes['application.type'] IN ($app_type) AND SpanAttributes['user.id'] IN ($user_id) AND SpanAttributes['agent.llm.model'] IN ($model) GROUP BY model ORDER BY tokens DESC",
          "refId": "A",
          "round": "0s",
          "skip_comments": true,
          "useWindowFuncForMacros": true
        }
      ],
      "title": "Token Usage by Model",
      "type": "barchart"
    }
  ],
  "preload": false,
  "refresh": "1m",
  "schemaVersion": 42,
  "tags": [
    "LLM",
    "Telemetry",
    "ClickHouse",
    "OpenTelemetry"
  ],
  "templating": {
    "list": [
      {
        "current": {
          "text": "All",
          "value": [
            "$__all"
          ]
        },
        "datasource": "ClickHouse",
        "definition": "SELECT DISTINCT SpanAttributes['application.type'] AS value FROM otel_traces WHERE Timestamp BETWEEN toDateTime($__from/1000) AND toDateTime($__to/1000) AND SpanAttributes['application.type'] != ''",
        "includeAll": true,
        "label": "Application Type",
        "multi": true,
        "name": "app_type",
        "options": [
          {
            "selected": false,
            "text": "qwery-cli",
            "value": "qwery-cli"
          },
          {
            "selected": false,
            "text": "qwery-web-server",
            "value": "qwery-web-server"
          }
        ],
        "query": {
          "adHocFilters": [],
          "adHocValuesQuery": "",
          "add_metadata": true,
          "contextWindowSize": "10",
          "datasourceMode": "Variable",
          "editorMode": "builder",
          "extrapolate": true,
          "format": "time_series",
          "formattedQuery": "/* grafana dashboard='LLM Observability Dashboard', user=1 */\nSELECT DISTINCT SpanAttributes['application.type'] AS value FROM otel_traces WHERE Timestamp BETWEEN toDateTime(1766064755378/1000) AND toDateTime(1766065655378/1000) AND SpanAttributes['application.type'] != ''",
          "interval": "",
          "intervalFactor": 1,
          "nullifySparse": false,
          "query": "SELECT DISTINCT SpanAttributes['application.type'] AS value FROM otel_traces WHERE Timestamp BETWEEN toDateTime($__from/1000) AND toDateTime($__to/1000) AND SpanAttributes['application.type'] != ''",
          "round": "0s",
          "skip_comments": true,
          "useWindowFuncForMacros": true
        },
        "type": "query"
      },
      {
        "current": {
          "text": "All",
          "value": "$__all"
        },
        "datasource": "ClickHouse",
        "definition": "SELECT DISTINCT SpanAttributes['user.id'] AS value FROM otel_traces WHERE Timestamp BETWEEN toDateTime($__from/1000) AND toDateTime($__to/1000) AND SpanAttributes['user.id'] != ''",
        "includeAll": true,
        "label": "User ID",
        "multi": true,
        "name": "user_id",
        "options": [
          {
            "selected": false,
            "text": "cli-1765813001600-bpxq1zs",
            "value": "cli-1765813001600-bpxq1zs"
          },
          {
            "selected": false,
            "text": "cli-1766051924571-27q4q45",
            "value": "cli-1766051924571-27q4q45"
          },
          {
            "selected": false,
            "text": "cli-1766054556215-hmc21sc",
            "value": "cli-1766054556215-hmc21sc"
          },
          {
            "selected": false,
            "text": "web-1766055173083-4bo9fk4",
            "value": "web-1766055173083-4bo9fk4"
          },
          {
            "selected": false,
            "text": "web-1766055689878-sszn8vi",
            "value": "web-1766055689878-sszn8vi"
          },
          {
            "selected": false,
            "text": "web-1766065295881-yugqvzi",
            "value": "web-1766065295881-yugqvzi"
          },
          {
            "selected": false,
            "text": "web-1766065544866-y1ki9q2",
            "value": "web-1766065544866-y1ki9q2"
          }
        ],
        "query": {
          "adHocFilters": [],
          "adHocValuesQuery": "",
          "add_metadata": true,
          "contextWindowSize": "10",
          "datasourceMode": "Variable",
          "editorMode": "builder",
          "extrapolate": true,
          "format": "time_series",
          "formattedQuery": "/* grafana dashboard='LLM Observability Dashboard', user=1 */\nSELECT DISTINCT SpanAttributes['user.id'] AS value FROM otel_traces WHERE Timestamp BETWEEN toDateTime(1766064755378/1000) AND toDateTime(1766065655378/1000) AND SpanAttributes['user.id'] != ''",
          "interval": "",
          "intervalFactor": 1,
          "nullifySparse": false,
          "query": "SELECT DISTINCT SpanAttributes['user.id'] AS value FROM otel_traces WHERE Timestamp BETWEEN toDateTime($__from/1000) AND toDateTime($__to/1000) AND SpanAttributes['user.id'] != ''",
          "round": "0s",
          "skip_comments": true,
          "useWindowFuncForMacros": true
        },
        "type": "query"
      },
      {
        "current": {
          "text": "All",
          "value": "$__all"
        },
        "datasource": "ClickHouse",
        "definition": "SELECT DISTINCT SpanAttributes['agent.actor'] AS value FROM otel_traces WHERE Timestamp BETWEEN toDateTime($__from/1000) AND toDateTime($__to/1000) AND SpanAttributes['agent.actor'] != ''",
        "includeAll": true,
        "label": "Agent",
        "multi": true,
        "name": "agent",
        "options": [
          {
            "selected": false,
            "text": "detectIntent",
            "value": "detectIntent"
          },
          {
            "selected": false,
            "text": "greeting",
            "value": "greeting"
          },
          {
            "selected": false,
            "text": "loadContext",
            "value": "loadContext"
          },
          {
            "selected": false,
            "text": "readData",
            "value": "readData"
          },
          {
            "selected": false,
            "text": "summarizeIntent",
            "value": "summarizeIntent"
          }
        ],
        "query": {
          "adHocFilters": [],
          "adHocValuesQuery": "",
          "add_metadata": true,
          "contextWindowSize": "10",
          "datasourceMode": "Variable",
          "editorMode": "builder",
          "extrapolate": true,
          "format": "time_series",
          "formattedQuery": "/* grafana dashboard='LLM Observability Dashboard', user=1 */\nSELECT DISTINCT SpanAttributes['agent.actor'] AS value FROM otel_traces WHERE Timestamp BETWEEN toDateTime(1766064755378/1000) AND toDateTime(1766065655378/1000) AND SpanAttributes['agent.actor'] != ''",
          "interval": "",
          "intervalFactor": 1,
          "nullifySparse": false,
          "query": "SELECT DISTINCT SpanAttributes['agent.actor'] AS value FROM otel_traces WHERE Timestamp BETWEEN toDateTime($__from/1000) AND toDateTime($__to/1000) AND SpanAttributes['agent.actor'] != ''",
          "round": "0s",
          "skip_comments": true,
          "useWindowFuncForMacros": true
        },
        "type": "query"
      },
      {
        "current": {
          "text": "All",
          "value": "$__all"
        },
        "datasource": "ClickHouse",
        "definition": "SELECT DISTINCT SpanAttributes['agent.llm.model'] AS value FROM otel_traces WHERE Timestamp BETWEEN toDateTime($__from/1000) AND toDateTime($__to/1000) AND SpanAttributes['agent.llm.model'] != ''",
        "includeAll": true,
        "label": "Model",
        "multi": true,
        "name": "model",
        "options": [],
        "query": {
          "adHocFilters": [],
          "adHocValuesQuery": "",
          "add_metadata": true,
          "contextWindowSize": "10",
          "datasourceMode": "Variable",
          "editorMode": "builder",
          "extrapolate": true,
          "format": "time_series",
          "formattedQuery": "/* grafana dashboard='LLM Observability Dashboard', user=1 */\nSELECT DISTINCT SpanAttributes['agent.llm.model'] AS value FROM otel_traces WHERE Timestamp BETWEEN toDateTime(1766064755378/1000) AND toDateTime(1766065655378/1000) AND SpanAttributes['agent.llm.model'] != ''",
          "interval": "",
          "intervalFactor": 1,
          "nullifySparse": false,
          "query": "SELECT DISTINCT SpanAttributes['agent.llm.model'] AS value FROM otel_traces WHERE Timestamp BETWEEN toDateTime($__from/1000) AND toDateTime($__to/1000) AND SpanAttributes['agent.llm.model'] != ''",
          "round": "0s",
          "skip_comments": true,
          "useWindowFuncForMacros": true
        },
        "type": "query"
      }
    ]
  },
  "time": {
    "from": "now-30d",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": [
      "10s",
      "30s",
      "1m",
      "5m",
      "15m",
      "1h",
      "6h",
      "12h",
      "24h",
      "7d"
    ]
  },
  "timezone": "browser",
  "title": "LLM Observability Dashboard",
  "uid": "llm-telemetry-dashboard",
  "version": 28
}